---
# tasks file for invoiceplane

- name: Set up InvoicePlane files
  git:
    dest: "{{ ip_web_root }}"
    repo: "{{ ip_git_url }}"
    force: yes
    refspec: "{{ ip_git_refspec }}"
  register: ip_git_status

- name: Debug git status
  debug:
    var: ip_git_status
    verbosity: 2

- name: Set owner for invoiceplane directory
  file:
    path: "{{ ip_web_root }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    recurse: yes
    state: directory

- name: Ensure InvoicePlane config file
  copy:
    remote_src: true
    src: "{{ ip_web_root }}/ipconfig.php.example"
    dest: "{{ ip_web_root }}/ipconfig.php"
    force: no

- name: Add 'Managed with Ansible' notice
  lineinfile:
    path: "{{ ip_web_root }}/ipconfig.php"
    line: "# InvoicePlane Configuration File - managed by Ansible. DO NOT MODIFY THIS FILE DIRECTLY"
    regexp: '^# InvoicePlane Configuration File$'

- name: Ensure lines in the config file
  ini_file:
    state: present
    dest: "{{ ip_web_root }}/ipconfig.php"
    section: null
    no_extra_spaces: yes
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
    - option: IP_URL
      value: "{{ ip_url }}"
    - option: DB_HOSTNAME
      value: "localhost"
    - option: DB_USERNAME
      value: "{{ ip_db_user }}"
    - option: DB_PASSWORD
      value: "{{ ip_db_pass }}"
    - option: DB_DATABASE
      value: "{{ ip_db_name }}"
    - option: DB_PORT
      value: "{{ mysql_port }}"
    - option: REMOVE_INDEXPHP
      value: "{{ ip_remove_indexphp }}"
    - option: DISABLE_READ_ONLY
      value: "{{ ip_disable_invoice_readonly }}"
    - option: DISABLE_SETUP
      value: "{{ ip_disable_setup }}"

- name: Install node dependencies
  shell: yarn install --no-lockfile
  args:
    chdir: "{{ ip_web_root }}"
    creates: node_modules
  register: ip_yarn_install

- name: Debug yarn install
  debug:
    var: ip_yarn_install
    verbosity: 2

- name: Run Composer
  shell: composer install -o --no-interaction --no-dev --no-suggest
  args:
    chdir: "{{ ip_web_root }}"
  when: ip_git_status.changed

- name: Run Grunt
  shell: "{{ npm_config_prefix }}/bin/grunt"
  args:
    chdir: "{{ ip_web_root }}"
  when: ip_git_status.changed or ip_yarn_install.changed
